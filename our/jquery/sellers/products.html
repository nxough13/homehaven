<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Management</title>
  <link rel="stylesheet" href="../css/style.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/additional-methods.min.js"></script>
  <style>
    body {
      background: #f5f3f0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .main-card {
      background: #f8f5f2;
      border-radius: 28px;
      box-shadow: 0 2px 16px rgba(139,92,42,0.08);
      max-width: 1400px;
      width: 95%;
      margin: 0 auto 35px auto;
      padding: 2px 32px 32px 32px;
      border: 6px solid #e5e0da;
    }
    .main-card h2 {
      text-align: center;
      font-size: 2rem;
      font-weight: 500;
      margin-bottom: 18px;
      color: #333;
    }
    .action-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 18px;
      justify-content: flex-end;
    }
    .btn {
      border: none;
      border-radius: 12px;
      padding: 8px 18px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .btn-beige {
      background: #e5d3bc;
      color: #5a4632;
    }
    .btn-beige:hover {
      background: #d6c2a8;
    }
    .btn-blue {
      background: #dbe3f7;
      color: #2a3a5c;
    }
    .btn-blue:hover {
      background: #b7c6e6;
    }
    .btn-gray {
      background: #bdbdbd;
      color: #333;
    }
    .btn-gray:hover {
      background: #a0a0a0;
    }
    .btn-red {
      background: #ff6b6b;
      color: white;
    }
    .btn-red:hover {
      background: #e74c3c;
    }
    .table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(139,92,42,0.06);
    }
    th, td {
      padding: 16px 14px;
      text-align: left;
      font-size: 1rem;
    }
    th {
      background: #ede3d3;
      color: #5a4632;
      font-weight: 600;
    }
    tr:not(:last-child) td {
      border-bottom: 1px solid #f0e6d8;
    }
    .status-badge {
      padding: 4px 14px;
      border-radius: 16px;
      font-size: 0.95rem;
      font-weight: 600;
      background: #ede3d3;
      color: #5a4632;
      display: inline-block;
    }
    .status-inactive {
      background: #ff6b6b;
      color: #fff;
    }
    .stock-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      display: inline-block;
    }
    .stock-available {
      background: #d5f4e6;
      color: #27ae60;
    }
    .stock-low {
      background: #fef5e7;
      color: #f39c12;
    }
    .stock-out {
      background: #fadbd8;
      color: #e74c3c;
    }
    .img-thumb {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #eee;
      margin-right: 4px;
      background: #f5f3f0;
    }
    .img-thumb-wrapper {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .modal-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    /* Form Validation Styles */
    .form-group {
      position: relative;
      margin-bottom: 1rem;
    }
    
    .form-group.error input,
    .form-group.error select,
    .form-group.error textarea {
      border-color: #e74c3c !important;
      box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);
    }
    
    .form-group.success input,
    .form-group.success select,
    .form-group.success textarea {
      border-color: #27ae60 !important;
      box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.2);
    }
    
    .error-message {
      color: #e74c3c;
      font-size: 0.85rem;
      margin-top: 0.25rem;
      display: none;
    }
    
    .form-group.error .error-message {
      display: block;
    }
    
    .success-message {
      color: #27ae60;
      font-size: 0.85rem;
      margin-top: 0.25rem;
      display: none;
    }
    
    .form-group.success .success-message {
      display: block;
    }
    
    .validation-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
    }
    
    .form-group.error .validation-icon {
      color: #e74c3c;
    }
    
    .form-group.success .validation-icon {
      color: #27ae60;
    }
    .custom-modal {
      background: #f8f5f2;
      border-radius: 22px;
      box-shadow: 0 8px 32px rgba(139,92,42,0.18);
      max-width: 420px;
      width: 100%;
      margin: 0 auto;
      border: 1px solid #e5e0da;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      padding: 18px 24px 24px 24px;
      margin-left: auto !important;
      margin-right: auto !important;
      left: 0;
      right: 0;
    }
    @media (max-width: 500px) {
      .custom-modal {
        max-width: 98vw;
        padding: 12px 4vw 18px 4vw;
      }
    }
    .custom-modal-header {
      background: #e5d3bc;
      border-radius: 22px 22px 0 0;
      padding: 18px 24px 10px 24px;
      font-size: 1.3rem;
      font-weight: 600;
      color: #5a4632;
      margin-bottom: 0;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      box-sizing: border-box;
    }
    .custom-modal-title {
      flex: 1 1 auto;
      text-align: left;
      padding-right: 12px;
      line-height: 1.2;
      display: flex;
      align-items: center;
    }
    .modal-close-btn {
      background: none;
      border: none;
      color: #5a4632;
      font-size: 1.6rem;
      font-weight: bold;
      cursor: pointer;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      margin-left: 12px;
    }
    .modal-close-btn:hover {
      background: #e5e0da;
    }
    .custom-modal-body {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 10px 24px 0 0px;
    }
    .mb-3 {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      margin-bottom: 14px;
    }
    .form-label {
      font-weight: 600;
      color: #5a4632;
      margin-bottom: 2px;
      text-align: left;
      width: 100%;
      font-size: 0.95rem;
      padding-left: 0;
      margin-left: 0;
    }
    .form-control, select, textarea {
      border-radius: 8px;
      border: 1.5px solid #e5e0da;
      padding: 4px 8px;
      font-size: 0.93rem;
      margin-bottom: 0;
      background: #fff;
      color: #333;
      box-shadow: none;
      outline: none;
      transition: border 0.2s;
      width: 100%;
      box-sizing: border-box;
      margin-left: 0 !important;
      padding-left: 0 !important;
      display: block;
      margin-top: 0;
    }
    .form-control:focus, select:focus {
      border-color: #b7c6e6;
    }
    .existing-imgs-label {
      font-weight: 600;
      margin-bottom: 4px;
      color: #333;
    }
    .remove-img-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 0.9rem;
      margin-left: -18px;
      margin-right: 2px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 2;
    }
    .remove-img-btn:hover {
      background: #c0392b;
    }
    .btn-sm {
      padding: 4px 8px;
      font-size: 0.85rem;
      margin: 2px;
    }
    .photo-count-box {
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      margin-left: 4px;
    }
    td .btn {
      display: inline-block;
      margin: 2px;
    }
    .carousel-container {
      position: relative;
      width: 120px;
      height: 120px;
      overflow: hidden;
      border-radius: 8px;
      border: 1px solid #eee;
    }
    .carousel-slide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .carousel-slide.active {
      opacity: 1;
    }
    .carousel-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .carousel-nav {
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 2px;
      z-index: 2;
    }
    .carousel-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      cursor: pointer;
      transition: background 0.2s;
    }
    .carousel-dot.active {
      background: rgba(255,255,255,0.9);
    }
    .carousel-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 14px;
      cursor: pointer;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .carousel-arrow:hover {
      background: rgba(0,0,0,0.8);
    }
    .carousel-arrow.prev {
      left: 2px;
    }
    .carousel-arrow.next {
      right: 2px;
    }
    .carousel-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Custom Notification Styles */
    .notification-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .notification-popup {
      background: white;
      border-radius: 16px;
      padding: 0;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .notification-header {
      padding: 20px 20px 0 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .notification-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }
    
    .notification-icon.success {
      background: #d4edda;
      color: #155724;
    }
    
    .notification-icon.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .notification-icon.warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .notification-icon.info {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .notification-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      margin: 0;
    }
    
    .notification-body {
      padding: 20px;
      color: #666;
      line-height: 1.5;
    }
    
    .notification-footer {
      padding: 0 20px 20px 20px;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .notification-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .notification-btn.primary {
      background: #8B5C2A;
      color: white;
    }
    
    .notification-btn.primary:hover {
      background: #7a4f24;
    }
    
    .notification-btn.secondary {
      background: #e0d6c6;
      color: #5a4632;
    }
    
    .notification-btn.secondary:hover {
      background: #d6c2a8;
    }
    
    .notification-btn.danger {
      background: #dc3545;
      color: white;
    }
    
    .notification-btn.danger:hover {
      background: #c82333;
    }
    
    /* Loading spinner */
    .loading-spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1500;
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #8B5C2A;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .main-card {
        width: 98%;
        padding: 1px 16px 16px 16px;
      }
      .action-bar {
        flex-direction: column;
        gap: 12px;
      }
      .custom-modal {
        width: 95%;
        margin: 20px;
      }
      .notification-popup {
        width: 95%;
        margin: 20px;
      }
    }
    .img-thumb-wrapper {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .existing-images-carousel {
      position: relative;
      width: 100%;
      max-width: 400px;
    }
    .existing-images-carousel .carousel-slides {
      display: flex;
      overflow: hidden;
      border-radius: 8px;
    }
    .existing-images-carousel .carousel-slide {
      position: relative;
      flex-shrink: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .existing-images-carousel .carousel-slide:not(.active) {
      display: none;
    }
    .existing-images-carousel .carousel-dots {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin-top: 8px;
    }
    .existing-images-carousel .carousel-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ccc;
      cursor: pointer;
      transition: background 0.2s;
    }
    .existing-images-carousel .carousel-dot.active {
      background: #8B5C2A;
    }
    .remove-image-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .remove-image-btn:hover {
      background: #c82333;
    }
    /* Table carousel styles */
    .carousel-container {
      position: relative;
      width: 120px;
      height: 120px;
      overflow: hidden;
      border-radius: 8px;
    }
    .carousel-container .carousel-slides {
      display: flex;
      width: 100%;
      height: 100%;
    }
    .carousel-container .carousel-slide {
      position: relative;
      flex-shrink: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .carousel-container .carousel-slide:not(.active) {
      display: none;
    }
    .carousel-container .carousel-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }
    .carousel-container .carousel-dots {
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 2px;
      background: rgba(0,0,0,0.5);
      padding: 2px 4px;
      border-radius: 10px;
    }
    .carousel-container .carousel-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255,255,255,0.6);
      cursor: pointer;
      transition: background 0.2s;
    }
    .carousel-container .carousel-dot.active {
      background: #fff;
    }
    .carousel-container .carousel-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .carousel-container .carousel-nav:hover {
      background: rgba(0,0,0,0.7);
    }
    .carousel-container .carousel-nav.prev {
      left: 4px;
    }
    .carousel-container .carousel-nav.next {
      right: 4px;
    }
    /* Hover effects for table carousels */
    .carousel-container:hover .carousel-nav {
      opacity: 1;
    }
    .carousel-container .carousel-nav {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .carousel-container:hover .carousel-dots {
      opacity: 1;
    }
    .carousel-container .carousel-dots {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body>
  <div id="header"></div>
  <script>$(function(){$('#header').load('../header.html');});</script>
  <div class="main-card">
    <h2>Product Management</h2>
    <div class="action-bar">
      <button class="btn btn-beige" id="printReportBtn">Print Report</button>
      <button class="btn btn-beige" id="addProductBtn">Add Product</button>
    </div>
    <table class="table" id="productsTable">
      <thead>
        <tr>
          <th>Id</th>
          <th>Name</th>
          <th>Price</th>
          <th>Category</th>
          <th>Stock</th>
          <th>Photo</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
          <tbody>
            <!-- Products will be loaded here -->
          </tbody>
    </table>
      </div>

  <!-- Add/Edit Product Modal -->
  <div class="modal modal-bg" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true" style="display:none;">
    <div class="custom-modal">
      <form id="productForm" enctype="multipart/form-data">
        <div class="custom-modal-header">
          <span class="custom-modal-title">Add/Edit Product</span>
          <button type="button" class="modal-close-btn" id="closeProductModalBtn" aria-label="Close">&times;</button>
        </div>
        <div class="custom-modal-body">
          <input type="hidden" id="productId">
          <div class="form-group mb-3">
            <label for="productName" class="form-label">Name</label>
            <input type="text" class="form-control" id="productName" name="name" required minlength="3" maxlength="100">
            <div class="error-message"></div>
            <div class="success-message">‚úì Valid product name</div>
            <span class="validation-icon"></span>
          </div>
          <div class="form-group mb-3">
            <label for="productCategory" class="form-label">Category</label>
            <select class="form-control" id="productCategory" name="category_id" required>
              <option value="">Select a category</option>
            </select>
            <div class="error-message"></div>
            <div class="success-message">‚úì Category selected</div>
            <span class="validation-icon"></span>
          </div>
          <div class="form-group mb-3">
            <label for="productSKU" class="form-label">SKU</label>
            <input type="text" class="form-control" id="productSKU" name="sku" required minlength="3" maxlength="50" pattern="^[A-Za-z0-9\-_]+$">
            <div class="error-message"></div>
            <div class="success-message">‚úì Valid SKU</div>
            <span class="validation-icon"></span>
          </div>
          <div class="form-group mb-3">
            <label for="productPrice" class="form-label">Price</label>
            <input type="number" class="form-control" id="productPrice" name="sell_price" required min="0.01" step="0.01" max="999999.99">
            <div class="error-message"></div>
            <div class="success-message">‚úì Valid price</div>
            <span class="validation-icon"></span>
          </div>
          <div class="form-group mb-3">
            <label for="productStock" class="form-label">Stock</label>
            <input type="number" class="form-control" id="productStock" name="stock" required min="0" step="1" max="999999">
            <div class="error-message"></div>
            <div class="success-message">‚úì Valid stock quantity</div>
            <span class="validation-icon"></span>
          </div>
          <div class="form-group mb-3">
            <label for="productImages" class="form-label">Product Images</label>
            <input type="file" class="form-control" id="productImages" name="images" accept="image/*" multiple>
            <div class="error-message"></div>
            <div class="success-message">‚úì Images selected</div>
            <span class="validation-icon"></span>
            <input type="hidden" id="removeImages" value="[]">
            <div id="existingImagesSection" class="mt-2" style="display:none;">
              <div class="existing-imgs-label">Existing Images:</div>
              <div id="existingImages" class="img-thumb-wrapper"></div>
            </div>
          </div>
          <div class="mb-3">
            <label for="productStatus" class="form-label">Status</label>
            <select class="form-control" id="productStatus" name="status">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
          </div>
          <div class="mb-3">
            <label for="productDescription" class="form-label">Description</label>
            <textarea class="form-control" id="productDescription" name="description"></textarea>
          </div>
        </div>
        <div class="custom-modal-footer">
          <button type="button" class="btn btn-gray" id="cancelProductBtn">Cancel</button>
          <button type="submit" class="btn btn-blue">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Customer Reviews Section -->
  <div class="main-card" id="reviewsSection" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <h2 id="reviewsTitle">Customer Reviews</h2>
      <button class="btn btn-gray btn-sm" id="closeReviewsBtn" style="margin:0;">Close Reviews</button>
    </div>
    <div id="reviewsList"></div>
  </div>

  <!-- Custom Notification Overlay -->
  <div class="notification-overlay" id="notificationOverlay">
    <div class="notification-popup" id="notificationPopup">
      <div class="notification-header">
        <div class="notification-icon" id="notificationIcon">‚úì</div>
        <h3 class="notification-title" id="notificationTitle">Success</h3>
      </div>
      <div class="notification-body" id="notificationBody">
        Operation completed successfully.
      </div>
      <div class="notification-footer" id="notificationFooter">
        <button class="notification-btn secondary" onclick="hideNotification()">Close</button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-spinner" id="loadingSpinner">
    <div class="spinner"></div>
  </div>

  <script>
    // Use a different variable name to avoid conflict with seller.js
    const REVIEWS_API_BASE = 'http://localhost:4000/api/v1';
    
    // Custom Notification Functions
    function showNotification(type, title, message, buttons = []) {
      const overlay = document.getElementById('notificationOverlay');
      const popup = document.getElementById('notificationPopup');
      const icon = document.getElementById('notificationIcon');
      const titleEl = document.getElementById('notificationTitle');
      const body = document.getElementById('notificationBody');
      const footer = document.getElementById('notificationFooter');
      
      // Set icon and colors based on type
      switch(type) {
        case 'success':
          icon.textContent = '‚úì';
          icon.className = 'notification-icon success';
          break;
        case 'error':
          icon.textContent = '‚úï';
          icon.className = 'notification-icon error';
          break;
        case 'warning':
          icon.textContent = '‚ö†';
          icon.className = 'notification-icon warning';
          break;
        case 'info':
          icon.textContent = '‚Ñπ';
          icon.className = 'notification-icon info';
          break;
      }
      
      titleEl.textContent = title;
      body.textContent = message;
      
      // Clear existing buttons and add new ones
      footer.innerHTML = '';
      if (buttons.length === 0) {
        footer.innerHTML = '<button class="notification-btn secondary" onclick="hideNotification()">Close</button>';
      } else {
        buttons.forEach(btn => {
          const button = document.createElement('button');
          button.className = `notification-btn ${btn.type || 'secondary'}`;
          button.textContent = btn.text;
          button.onclick = btn.onclick || (() => hideNotification());
          footer.appendChild(button);
        });
      }
      
      overlay.style.display = 'flex';
    }
    
    function hideNotification() {
      document.getElementById('notificationOverlay').style.display = 'none';
    }
    
    function showLoading() {
      document.getElementById('loadingSpinner').style.display = 'block';
    }
    
    function hideLoading() {
      document.getElementById('loadingSpinner').style.display = 'none';
    }
    
    function renderReviews(reviews) {
      let html = '';
      if (!reviews || !reviews.length) {
        html = '<div style="color:#888;text-align:center;padding:20px;">No reviews yet for this product.</div>';
      } else {
        reviews.forEach(r => {
          const stars = '‚òÖ'.repeat(r.rating) + '‚òÜ'.repeat(5-r.rating);
          html += `<div class='review-box' style='border-bottom:1px solid #eee;padding:15px 0;'>
            <div style='font-weight:600;color:#333;'>${escapeHtml(r.fname || '')} ${escapeHtml(r.lname || '')} <span style='color:#f5b301;'>${stars}</span></div>
            <div style='margin:8px 0 0 0;color:#666;'>${r.review_text ? escapeHtml(r.review_text) : ''}</div>
            <div style='font-size:0.9em;color:#aaa;margin-top:5px;'>${new Date(r.created_at).toLocaleString()}</div>
          </div>`;
        });
      }
      $('#reviewsList').html(html);
    }

    async function loadReviews(item_id) {
      try {
        const res = await fetch(`${REVIEWS_API_BASE}/products/${item_id}/reviews`);
        const data = await res.json();
        if (data.success) {
          renderReviews(data.reviews);
          $('#reviewsSection').show();
        } else {
          console.error('Failed to load reviews:', data.message);
          $('#reviewsList').html('<div style="color:#e74c3c;text-align:center;padding:20px;">Failed to load reviews.</div>');
          $('#reviewsSection').show();
        }
      } catch (error) {
        console.error('Error loading reviews:', error);
        $('#reviewsList').html('<div style="color:#e74c3c;text-align:center;padding:20px;">Error loading reviews.</div>');
        $('#reviewsSection').show();
      }
    }

    // Print report functionality
    function printProductReport() {
      const printWindow = window.open('', '_blank');
      const sellerName = localStorage.getItem('user_name') || 'Seller';
      const currentDate = new Date().toLocaleDateString();
      const currentTime = new Date().toLocaleTimeString();
      
      // Calculate summary statistics
      const totalProducts = allProducts.length;
      const activeProducts = allProducts.filter(p => p.status === 'active').length;
      const inactiveProducts = allProducts.filter(p => p.status === 'inactive').length;
      const outOfStock = allProducts.filter(p => parseInt(p.stock_quantity || p.stock || 0) === 0).length;
      const lowStock = allProducts.filter(p => {
        const stock = parseInt(p.stock_quantity || p.stock || 0);
        return stock > 0 && stock <= 10;
      }).length;
      
      // Calculate total inventory value
      const totalValue = allProducts.reduce((sum, product) => {
        const stock = parseInt(product.stock_quantity || product.stock || 0);
        const price = parseFloat(product.sell_price || 0);
        return sum + (stock * price);
      }, 0);
      
      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Product Report - ${sellerName}</title>
          <style>
            body { 
              font-family: 'Georgia', 'Times New Roman', serif; 
              margin: 20px; 
              background: #f7f4f0;
              color: #444;
            }
            .header { 
              text-align: center; 
              margin-bottom: 30px; 
              border-bottom: 3px solid #8B5C2A; 
              padding-bottom: 20px; 
              background: linear-gradient(135deg, #8B5C2A, #a67c52);
              color: white;
              padding: 30px 20px;
              border-radius: 12px;
              margin: -20px -20px 30px -20px;
            }
            .header h1 {
              margin: 0 0 10px 0;
              font-size: 2.5rem;
              font-weight: 700;
            }
            .header p {
              margin: 5px 0;
              font-size: 1.1rem;
              opacity: 0.9;
            }
            .summary { 
              margin-bottom: 30px; 
              background: white;
              padding: 25px;
              border-radius: 12px;
              box-shadow: 0 4px 16px rgba(139,92,42,0.1);
            }
            .summary h2 {
              color: #8B5C2A;
              margin-bottom: 20px;
              font-size: 1.8rem;
              border-bottom: 2px solid #e0d6c6;
              padding-bottom: 10px;
            }
            .summary-grid { 
              display: grid; 
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
              gap: 20px; 
              margin-bottom: 20px; 
            }
            .summary-item { 
              background: linear-gradient(135deg, #f8f5f2, #e8e0d8); 
              padding: 20px; 
              border-radius: 12px; 
              text-align: center; 
              border: 2px solid #e0d6c6;
              box-shadow: 0 2px 8px rgba(139,92,42,0.08);
            }
            .summary-value { 
              font-size: 28px; 
              font-weight: bold; 
              color: #8B5C2A; 
              margin-bottom: 8px;
            }
            .summary-label { 
              color: #666; 
              font-size: 0.95rem;
              font-weight: 500;
            }
            .product-details {
              background: white;
              padding: 25px;
              border-radius: 12px;
              box-shadow: 0 4px 16px rgba(139,92,42,0.1);
            }
            .product-details h2 {
              color: #8B5C2A;
              margin-bottom: 20px;
              font-size: 1.8rem;
              border-bottom: 2px solid #e0d6c6;
              padding-bottom: 10px;
            }
            table { 
              width: 100%; 
              border-collapse: collapse; 
              margin-top: 20px; 
              background: white;
              border-radius: 8px;
              overflow: hidden;
              box-shadow: 0 2px 8px rgba(139,92,42,0.08);
            }
            th, td { 
              border: 1px solid #e0d6c6; 
              padding: 15px 12px; 
              text-align: left; 
            }
            th { 
              background: linear-gradient(135deg, #8B5C2A, #a67c52); 
              color: white; 
              font-weight: 600;
              font-size: 1rem;
            }
            tr:nth-child(even) {
              background: #f8f5f2;
            }
            tr:hover {
              background: #f0e6d8;
            }
            .status-active { 
              color: #28a745; 
              font-weight: 600;
            }
            .status-inactive { 
              color: #dc3545; 
              font-weight: 600;
            }
            .stock-out { 
              color: #dc3545; 
              font-weight: 600;
            }
            .stock-low { 
              color: #ffc107; 
              font-weight: 600;
            }
            .stock-available { 
              color: #28a745; 
              font-weight: 600;
            }
            .footer {
              margin-top: 30px;
              text-align: center;
              padding: 20px;
              background: linear-gradient(135deg, #8B5C2A, #a67c52);
              color: white;
              border-radius: 12px;
              font-size: 0.9rem;
            }
            .no-print { 
              margin-top: 30px; 
              text-align: center; 
            }
            .no-print button {
              padding: 12px 24px;
              border: none;
              border-radius: 8px;
              font-size: 1rem;
              font-weight: 600;
              cursor: pointer;
              margin: 0 8px;
              transition: all 0.2s;
            }
            .print-btn {
              background: linear-gradient(135deg, #8B5C2A, #a67c52);
              color: white;
            }
            .print-btn:hover {
              background: linear-gradient(135deg, #7a4f24, #8b6b4a);
              transform: translateY(-2px);
            }
            .close-btn {
              background: linear-gradient(135deg, #6c757d, #5a6268);
              color: white;
            }
            .close-btn:hover {
              background: linear-gradient(135deg, #5a6268, #495057);
              transform: translateY(-2px);
            }
            @media print {
              body { 
                margin: 0; 
                background: white;
              }
              .no-print { 
                display: none; 
              }
              .header {
                margin: 0 0 30px 0;
                border-radius: 0;
              }
              .summary, .product-details {
                box-shadow: none;
                border: 1px solid #e0d6c6;
              }
              table {
                box-shadow: none;
                border: 1px solid #e0d6c6;
              }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>üè† Home Haven</h1>
            <p><strong>Product Inventory Report</strong></p>
            <p><strong>Seller:</strong> ${sellerName}</p>
            <p><strong>Generated:</strong> ${currentDate} at ${currentTime}</p>
          </div>
          
          <div class="summary">
            <h2>üìä Summary</h2>
            <div class="summary-grid">
              <div class="summary-item">
                <div class="summary-value">${totalProducts}</div>
                <div class="summary-label">Total Products</div>
              </div>
              <div class="summary-item">
                <div class="summary-value">${activeProducts}</div>
                <div class="summary-label">Active Products</div>
              </div>
              <div class="summary-item">
                <div class="summary-value">${inactiveProducts}</div>
                <div class="summary-label">Inactive Products</div>
              </div>
              <div class="summary-item">
                <div class="summary-value">${outOfStock}</div>
                <div class="summary-label">Out of Stock</div>
              </div>
              <div class="summary-item">
                <div class="summary-value">${lowStock}</div>
                <div class="summary-label">Low Stock (‚â§10)</div>
              </div>
              <div class="summary-item">
                <div class="summary-value">‚Ç±${totalValue.toLocaleString()}</div>
                <div class="summary-label">Total Inventory Value</div>
              </div>
            </div>
          </div>
          
          <div class="product-details">
            <h2>üìã Product Details</h2>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Stock</th>
                  <th>Status</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                ${allProducts.map(product => {
                  const category = allCategories.find(c => c.category_id == product.category_id);
                  const stock = parseInt(product.stock_quantity || product.stock || 0);
                  const price = parseFloat(product.sell_price || 0);
                  const value = stock * price;
                  const stockClass = stock === 0 ? 'stock-out' : stock <= 10 ? 'stock-low' : 'stock-available';
                  const statusClass = product.status === 'active' ? 'status-active' : 'status-inactive';
      
      return `
                    <tr>
                      <td>${product.item_id}</td>
                      <td>${escapeHtml(product.name)}</td>
                      <td>${category ? escapeHtml(category.name) : ''}</td>
                      <td>‚Ç±${price.toLocaleString()}</td>
                      <td class="${stockClass}">${stock}</td>
                      <td class="${statusClass}">${product.status}</td>
                      <td>‚Ç±${value.toLocaleString()}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
              </div>
          
          <div class="footer">
            <p>üè† Home Haven - Quality furniture for every home</p>
            <p>¬© 2025 Home Haven. All rights reserved.</p>
          </div>
          
          <div class="no-print">
            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Report</button>
            <button class="close-btn" onclick="window.close()">‚ùå Close</button>
        </div>
        </body>
        </html>
      `;
      
      printWindow.document.write(printContent);
      printWindow.document.close();
    }

    // Show product reviews
    async function showProductReviews(productId) {
      try {
        showLoading();
        const response = await fetch(`http://localhost:4000/api/v1/reviews/${productId}`, {
          headers: { 'Authorization': `Bearer ${getJwt()}` }
        });
        const data = await response.json();
        
        if (data.success) {
          const product = allProducts.find(p => p.item_id == productId);
          $('#reviewsTitle').text(`Customer Reviews - ${product ? product.name : 'Product'}`);
          renderReviews(data.reviews);
          $('#reviewsSection').show();
        } else {
          showNotification('error', 'Failed to load reviews', data.message || 'Unable to load reviews at this time.');
        }
      } catch (error) {
        console.error('Error loading reviews:', error);
        showNotification('error', 'Failed to load reviews', 'Network error. Please try again later.');
      } finally {
        hideLoading();
      }
    }

    // Close reviews section
    function closeReviewsSection() {
      $('#reviewsSection').hide();
    }

    // Create carousel for multiple images
    function createCarousel(images, productId) {
      if (!images || images.length === 0) return '<div class="img-thumb" style="background:#f5f3f0;display:flex;align-items:center;justify-content:center;color:#999;">No Image</div>';
      
      if (images.length === 1) {
        const imgPath = images[0].startsWith('http') ? images[0] : `/our${images[0]}`;
        return `<img src="${imgPath}" class="img-thumb" alt="Product Image">`;
      }
      
      let carouselHtml = '<div class="carousel-container" data-product-id="' + productId + '">';
      carouselHtml += '<div class="carousel-slides">';
      
      images.forEach((img, index) => {
        const imgPath = img.startsWith('http') ? img : `/our${img}`;
        carouselHtml += `<div class="carousel-slide ${index === 0 ? 'active' : ''}" data-index="${index}">
          <img src="${imgPath}" class="img-thumb" alt="Product Image ${index + 1}">
        </div>`;
      });
      
      carouselHtml += '</div>';
      
      // Add navigation arrows if more than 1 image
      if (images.length > 1) {
        carouselHtml += '<button class="carousel-nav prev" onclick="changeSlide(' + productId + ', -1)">‚Äπ</button>';
        carouselHtml += '<button class="carousel-nav next" onclick="changeSlide(' + productId + ', 1)">‚Ä∫</button>';
        carouselHtml += '<div class="carousel-dots">';
        
        images.forEach((img, index) => {
          carouselHtml += `<span class="carousel-dot ${index === 0 ? 'active' : ''}" data-index="${index}" onclick="changeSlide(' + productId + ', ${index})"></span>`;
        });
        
        carouselHtml += '</div>';
      }
      
      carouselHtml += '</div>';
      return carouselHtml;
    }

    // Change carousel slide
    function changeSlide(productId, direction) {
      const container = document.querySelector(`[data-product-id="${productId}"]`);
      if (!container) return;
      
      const slides = container.querySelectorAll('.carousel-slide');
      const dots = container.querySelectorAll('.carousel-dot');
      const currentSlide = container.querySelector('.carousel-slide.active');
      const currentDot = container.querySelector('.carousel-dot.active');
      
      if (!currentSlide) return;
      
      let newIndex;
      
      // If direction is a number, it's a direct index
      if (typeof direction === 'number' && direction >= 0) {
        newIndex = direction;
      } else {
        // Otherwise it's a direction (-1 for prev, 1 for next)
        const currentIndex = parseInt(currentSlide.dataset.index);
        newIndex = currentIndex + direction;
      }
      
      // Loop around
      if (newIndex < 0) newIndex = slides.length - 1;
      if (newIndex >= slides.length) newIndex = 0;
      
      // Update active slide and dot
      currentSlide.classList.remove('active');
      if (currentDot) currentDot.classList.remove('active');
      
      slides[newIndex].classList.add('active');
      if (dots[newIndex]) dots[newIndex].classList.add('active');
    }

    // Function to show reviews for a specific product
    function showProductReviews(productId) {
      if (productId) {
        const product = allProducts.find(p => p.item_id == productId);
        if (product) {
          $('#reviewsTitle').text(`Customer Reviews - ${escapeHtml(product.name)}`);
          loadReviews(productId);
        }
      }
    }

    // Close reviews section
    function closeReviewsSection() {
      $('#reviewsSection').hide();
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Modal open/close logic: always allow opening after closing
    document.addEventListener('DOMContentLoaded', function() {
      var closeBtn = document.getElementById('closeProductModalBtn');
      var modal = document.getElementById('productModal');
      var addBtn = document.getElementById('addProductBtn');
      var cancelBtn = document.getElementById('cancelProductBtn');
      if (closeBtn && modal) {
        closeBtn.addEventListener('click', function() {
          modal.style.display = 'none';
        });
      }
      if (addBtn && modal) {
        addBtn.addEventListener('click', function() {
          modal.style.display = 'flex';
        });
      }
      if (cancelBtn && modal) {
        cancelBtn.addEventListener('click', function() {
          modal.style.display = 'none';
        });
      }
    });
  </script>
  <!-- Removed seller.js to avoid conflicts with inline script -->
  <script>
    $(function() {
      $(document).on('submit', '#productForm', function(e) {
        e.preventDefault(); // Prevent default form submission
        
        let valid = true;
        $('.product-error').remove();
        const name = $('#productName').val().trim();
        const sku = $('#productSKU').val().trim();
        const price = parseFloat($('#productPrice').val());
        const category = $('#productCategory').val();
        const stock = parseInt($('#productStock').val(), 10);
        const status = $('#productStatus').val();
        const description = $('#productDescription').val().trim();
        const images = $('#productImages')[0] ? $('#productImages')[0].files : null;
        const productId = $('#productId').val();
        
        // Validation
        if (!name) { $('#productName').after('<div class="product-error" style="color:#c00;font-size:0.95em;margin-top:2px;">Name is required.</div>'); valid = false; }
        if (!sku) { $('#productSKU').after('<div class="product-error" style="color:#c00;font-size:0.95em;margin-top:2px;">SKU is required.</div>'); valid = false; }
        if (isNaN(price) || price <= 0) { $('#productPrice').after('<div class="product-error" style="color:#c00;font-size:0.95em;margin-top:2px;">Enter a valid price.</div>'); valid = false; }
        if (!category) { $('#productCategory').after('<div class="product-error" style="color:#c00;font-size:0.95em;margin-top:2px;">Select a category.</div>'); valid = false; }
        if (isNaN(stock) || stock < 0) { $('#productStock').after('<div class="product-error" style="color:#c00;font-size:0.95em;margin-top:2px;">Enter a valid stock quantity.</div>'); valid = false; }
        
        // Only require images for add (not edit)
        if (!productId && (!images || images.length === 0)) {
          $('#productImages').after('<div class="product-error" style="color:#c00;font-size:0.95em;margin-top:2px;">At least one image is required.</div>');
          valid = false;
        }
        
        if (!valid) { return false; }
        
        // Submit form
        submitProductForm(productId, name, sku, price, category, stock, status, description, images);
      });
    });
    
    // Form submission function
    async function submitProductForm(productId, name, sku, price, category, stock, status, description, images) {
      showLoading();
      try {
        const formData = new FormData();
        formData.append('name', name);
        formData.append('sku', sku);
        formData.append('sell_price', price);
        formData.append('category_id', category);
        formData.append('stock', stock);
        formData.append('status', status);
        formData.append('description', description);
        
        // Add remove_images parameter if updating
        if (productId) {
          const removeImages = $('#removeImages').val();
          if (removeImages && removeImages !== '[]') {
            formData.append('remove_images', removeImages);
          }
        }
        
        // Add images if provided
        if (images && images.length > 0) {
          for (let i = 0; i < images.length; i++) {
            formData.append('images', images[i]);
          }
        }
        
        const url = productId 
          ? `http://localhost:4000/api/v1/seller/products/${productId}`
          : 'http://localhost:4000/api/v1/seller/products';
        
        const method = productId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: { 
            'Authorization': `Bearer ${getJwt()}`
          },
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          const action = productId ? 'updated' : 'added';
          showNotification('success', `Product ${action} successfully!`, 
            productId ? 'Your product has been updated with the new information.' : 'Your new product has been added to your inventory.');
          $('#productModal').hide();
          // Reload products
          allProducts = []; // Clear cache to force reload
          loadSellerProductsInfinite(false);
        } else {
          const action = productId ? 'update' : 'add';
          showNotification('error', `Failed to ${action} product`, data.message || 'Unknown error occurred. Please try again.');
        }
      } catch (error) {
        console.error('Error submitting product form:', error);
        const action = productId ? 'update' : 'add';
        showNotification('error', `Failed to ${action} product`, 'Network error. Please check your connection and try again.');
      } finally {
        hideLoading();
      }
    }
  </script>
  <script>
    // Global variables for products management
    let allProducts = [];
    let allCategories = [];
    let currentPage = 1;
    let productsPerPage = 12;
    let isLoadingMore = false;

    // Utility functions
    function escapeHtml(text) {
      return text ? text.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c])) : '';
    }

    function getJwt() {
      return localStorage.getItem('jwt_token');
    }

    // Action buttons for product table
    function getActionButtons(product) {
      const statusBtn = product.status === 'active'
        ? `<button class="btn btn-gray btn-sm status-btn" data-id="${product.item_id}" title="Set Inactive">Inactive</button>`
        : `<button class="btn btn-blue btn-sm status-btn" data-id="${product.item_id}" title="Set Active">Active</button>`;
      
      return `
        <button class="btn btn-red btn-sm delete-btn" data-id="${product.item_id}" title="Delete">Delete</button>
        <button class="btn btn-beige btn-sm edit-btn" data-id="${product.item_id}" title="Edit">Edit</button>
        <button class="btn btn-blue btn-sm reviews-btn" data-id="${product.item_id}" title="View Reviews">Reviews</button>
        ${statusBtn}
      `;
    }

    // Create product row with proper action buttons
    function createProductRow(product) {
      let imgs = '';
      let imageArray = [];
      
      // Parse images
      if (Array.isArray(product.image) && product.image.length > 0) {
        imageArray = product.image;
      } else if (typeof product.image === 'string') {
        try {
          imageArray = JSON.parse(product.image);
        } catch (e) {
          imageArray = [product.image];
        }
      }
      
      // Create carousel if multiple images, otherwise single image
      if (imageArray.length > 1) {
        imgs = createCarousel(imageArray, product.item_id);
      } else if (imageArray.length === 1) {
        const imagePath = imageArray[0].startsWith('http') ? imageArray[0] : `/our${imageArray[0]}`;
        imgs = `<img src="${imagePath}" class="img-thumb" alt="Product Image">`;
      } else {
        imgs = `<div class="img-thumb" style="background:#f5f3f0;display:flex;align-items:center;justify-content:center;color:#999;">No Image</div>`;
      }

      const statusClass = product.status === 'inactive' ? 'status-badge status-inactive' : 'status-badge';
      const category = allCategories.find(c => c.category_id == product.category_id);
      
      // Handle stock quantity display
      const stockQuantity = parseInt(product.stock_quantity || product.stock || product.quantity || 0);
      const stockClass = stockQuantity === 0 ? 'stock-out' : stockQuantity <= 10 ? 'stock-low' : 'stock-available';
      const stockText = stockQuantity === 0 ? 'Out of Stock' : stockQuantity <= 10 ? `${stockQuantity} left` : `${stockQuantity}`;
      
      return `<tr>
        <td>${product.item_id}</td>
        <td>${escapeHtml(product.name)}</td>
        <td>‚Ç±${parseFloat(product.sell_price).toLocaleString()}</td>
        <td>${category ? escapeHtml(category.name) : ''}</td>
        <td><span class="stock-badge ${stockClass}">${stockText}</span></td>
        <td><div class="img-thumb-wrapper">${imgs}</div></td>
        <td><span class="${statusClass}">${escapeHtml(product.status)}</span></td>
        <td>${getActionButtons(product)}</td>
      </tr>`;
    }

    // Load products with proper error handling
    async function loadSellerProductsInfinite(append = false) {
      try {
        if (!allProducts.length) {
          showLoading();
          const res = await fetch('http://localhost:4000/api/v1/seller/products', { 
            headers: { 'Authorization': `Bearer ${getJwt()}` } 
          });
          const data = await res.json();
          if (data.success) {
            allProducts = data.products || [];
          } else {
            console.error('Failed to load products:', data.message);
            throw new Error(data.message || 'Failed to load products');
          }
        }

        const tbody = $('#productsTable tbody');
        if (!append) tbody.empty();
        
        if (allProducts.length === 0) {
          tbody.append('<tr><td colspan="8" style="text-align:center;color:#888;">No products found.</td></tr>');
          return;
        }

        const startIndex = (currentPage - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        const pageProducts = allProducts.slice(startIndex, endIndex);
        
        pageProducts.forEach(product => {
          tbody.append(createProductRow(product));
        });

        // Setup event handlers for action buttons
        setupActionButtonHandlers();
        
      } catch (err) {
        console.error('Error loading products:', err);
        $('#productsTable tbody').append('<tr><td colspan="8" style="text-align:center;color:#e74c3c;">Failed to load products.</td></tr>');
        showNotification('error', 'Failed to load products', err.message || 'Unknown error');
      } finally {
        hideLoading();
      }
    }

    // Setup event handlers for action buttons
    function setupActionButtonHandlers() {
      // Delete button
      $(document).off('click.delete-btn').on('click.delete-btn', '.delete-btn', function() {
        const productId = $(this).data('id');
        const product = allProducts.find(p => p.item_id == productId);
        
        showNotification('warning', 'Confirm Delete', 
          `Are you sure you want to delete "${product ? product.name : 'this product'}"? This action cannot be undone.`,
          [
            { text: 'Cancel', type: 'secondary', onclick: () => hideNotification() },
            { text: 'Delete', type: 'danger', onclick: () => {
              hideNotification();
          deleteProduct(productId);
            }}
          ]
        );
      });

      // Edit button
      $(document).off('click.edit-btn').on('click.edit-btn', '.edit-btn', function() {
        const productId = $(this).data('id');
        const product = allProducts.find(p => p.item_id == productId);
        if (product) {
          showProductModal(true, product);
        }
      });

      // Status toggle button
      $(document).off('click.status-btn').on('click.status-btn', '.status-btn', function() {
        const productId = $(this).data('id');
        const product = allProducts.find(p => p.item_id == productId);
        if (product) {
          const newStatus = product.status === 'active' ? 'inactive' : 'active';
          const statusText = newStatus === 'active' ? 'activate' : 'deactivate';
          
          showNotification('info', 'Confirm Status Change', 
            `Are you sure you want to ${statusText} "${product.name}"?`,
            [
              { text: 'Cancel', type: 'secondary', onclick: () => hideNotification() },
              { text: 'Confirm', type: 'primary', onclick: () => {
                hideNotification();
                toggleProductStatus(productId, newStatus);
              }}
            ]
          );
        }
      });

      // Reviews button
      $(document).off('click.reviews-btn').on('click.reviews-btn', '.reviews-btn', function() {
        const productId = $(this).data('id');
        const product = allProducts.find(p => p.item_id == productId);
        if (product) {
          showProductReviews(productId);
          // Scroll to reviews section
          $('#reviewsSection')[0].scrollIntoView({ behavior: 'smooth' });
        }
      });
    }

    // Load categories for dropdown
    async function loadCategories() {
      try {
        showLoading();
        const response = await fetch('http://localhost:4000/api/v1/seller/categories', {
          headers: { 'Authorization': `Bearer ${getJwt()}` }
        });
        const data = await response.json();
        if (data.success) {
          allCategories = data.categories || [];
          // Populate category dropdown
          const categorySelect = $('#productCategory');
          categorySelect.empty();
          categorySelect.append('<option value="">Select Category</option>');
          allCategories.forEach(category => {
            categorySelect.append(`<option value="${category.category_id}">${category.name}</option>`);
          });
        } else {
          console.error('Failed to load categories:', data.message);
          showNotification('error', 'Failed to load categories', data.message || 'Unknown error');
        }
      } catch (error) {
        console.error('Error loading categories:', error);
        showNotification('error', 'Failed to load categories', 'Network error. Please try again.');
      } finally {
        hideLoading();
      }
    }

    // Delete product function
    async function deleteProduct(productId) {
      try {
        showLoading();
        const response = await fetch(`http://localhost:4000/api/v1/seller/products/${productId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${getJwt()}` }
        });
        const data = await response.json();
        if (data.success) {
          // Remove from local array and reload
          allProducts = allProducts.filter(p => p.item_id != productId);
          loadSellerProductsInfinite(false);
          showNotification('success', 'Product deleted successfully!', 'The product has been removed from your inventory.');
        } else {
          showNotification('error', 'Failed to delete product', data.message || 'Unknown error');
        }
      } catch (error) {
        console.error('Error deleting product:', error);
        showNotification('error', 'Failed to delete product', 'Network error. Please try again.');
      } finally {
        hideLoading();
      }
    }

    // Toggle product status
    async function toggleProductStatus(productId, newStatus) {
      try {
        showLoading();
        const response = await fetch(`http://localhost:4000/api/v1/seller/products/${productId}/status`, {
          method: 'PATCH',
          headers: { 
            'Authorization': `Bearer ${getJwt()}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: newStatus })
        });
        const data = await response.json();
        if (data.success) {
          // Update local array and reload
          const product = allProducts.find(p => p.item_id == productId);
          if (product) {
            product.status = newStatus;
          }
          loadSellerProductsInfinite(false);
          const statusText = newStatus === 'active' ? 'activated' : 'deactivated';
          showNotification('success', 'Product status updated successfully!', `The product has been ${statusText}.`);
        } else {
          showNotification('error', 'Failed to update product status', data.message || 'Unknown error');
        }
      } catch (error) {
        console.error('Error updating product status:', error);
        showNotification('error', 'Failed to update product status', 'Network error. Please try again.');
      } finally {
        hideLoading();
      }
    }

    // Show product modal for editing
    function showProductModal(editing = false, product = null) {
      const modal = document.getElementById('productModal');
      if (modal) {
        modal.style.display = 'flex';
        
        if (editing && product) {
          // Populate form with product data
          $('#productId').val(product.item_id);
          $('#productName').val(product.name);
          $('#productCategory').val(product.category_id);
          $('#productSKU').val(product.sku);
          $('#productPrice').val(product.sell_price);
          $('#productStock').val(product.stock_quantity || product.stock || 0);
          $('#productStatus').val(product.status);
          $('#productDescription').val(product.description || '');
          
          // Handle existing images
          if (product.image && product.image.length > 0) {
            $('#existingImagesSection').show();
            // Populate existing images display with carousel
            const existingImages = $('#existingImages');
            existingImages.empty();
            
            if (Array.isArray(product.image)) {
              let carouselHtml = '<div class="existing-images-carousel" data-product-id="' + product.item_id + '">';
              carouselHtml += '<div class="carousel-slides">';
              
              product.image.forEach((img, index) => {
                const imgPath = img.startsWith('http') ? img : `/our${img}`;
                carouselHtml += `<div class="carousel-slide ${index === 0 ? 'active' : ''}" data-index="${index}">
                  <img src="${imgPath}" class="img-thumb" style="width:80px;height:80px;object-fit:cover;margin:5px;">
                  <button type="button" class="remove-image-btn" data-image-path="${img}" style="position:absolute;top:2px;right:2px;background:red;color:white;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;">√ó</button>
                </div>`;
              });
              
              carouselHtml += '</div>';
              if (product.image.length > 1) {
                carouselHtml += '<div class="carousel-dots">';
                product.image.forEach((img, index) => {
                  carouselHtml += `<span class="carousel-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></span>`;
                });
                carouselHtml += '</div>';
              }
              carouselHtml += '</div>';
              
              existingImages.html(carouselHtml);
            }
          } else {
            $('#existingImagesSection').hide();
          }
        } else {
          // Clear form for new product
          $('#productForm')[0].reset();
          $('#productId').val('');
          $('#productStock').val('');
          $('#productDescription').val('');
          $('#removeImages').val('[]');
          $('#existingImagesSection').hide();
        }
      }
    }

    // Infinite scroll handler
    function handleInfiniteScrollSellerTable() {
      if (isLoadingMore) return;
      const table = document.getElementById('productsTable');
      if (!table) return;
      const scrollY = window.scrollY || window.pageYOffset;
      const windowH = window.innerHeight;
      const tableBottom = table.getBoundingClientRect().bottom + scrollY;
      if (scrollY + windowH + 200 >= tableBottom) {
        const totalPages = Math.ceil(allProducts.length / productsPerPage);
        if (currentPage < totalPages) {
          isLoadingMore = true;
          currentPage++;
          setTimeout(() => {
            loadSellerProductsInfinite(true);
            isLoadingMore = false;
          }, 300);
        }
      }
    }

    // Initialize page
    $(document).ready(function() {
      // Check authentication
      const jwt = getJwt();
      const role = localStorage.getItem('user_role');
      if (!jwt || role !== 'seller') {
        window.location.href = '../login.html?reason=unauthorized';
        return;
      }

      // Load initial data
      allProducts = [];
      currentPage = 1;
      
      // Load categories first, then products
      loadCategories().then(() => {
        loadSellerProductsInfinite(false);
      });

      // Setup infinite scroll
      $(window).off('scroll.sellercrud').on('scroll.sellercrud', handleInfiniteScrollSellerTable);

      // Setup modal events
      $('#addProductBtn').on('click', function() {
        showProductModal(false);
      });

      $('#closeProductModalBtn, #cancelProductBtn').on('click', function() {
        $('#productModal').hide();
      });

      // Print report button
      $('#printReportBtn').on('click', function() {
        if (allProducts.length === 0) {
          showNotification('info', 'No products available to generate report', 'Please add products first.');
          return;
        }
        printProductReport();
      });

      // Close reviews button
      $('#closeReviewsBtn').on('click', function() {
        closeReviewsSection();
      });

      // Carousel dot click handlers
      $(document).off('click.carousel-dot').on('click.carousel-dot', '.carousel-dot', function() {
        const container = $(this).closest('.carousel-container');
        const productId = container.data('product-id');
        const targetIndex = parseInt($(this).data('index'));
        
        // Update active slide and dot
        container.find('.carousel-slide.active').removeClass('active');
        container.find('.carousel-dot.active').removeClass('active');
        
        container.find(`.carousel-slide[data-index="${targetIndex}"]`).addClass('active');
        $(this).addClass('active');
      });

      // Existing images carousel navigation
      $(document).off('click.existing-carousel-dot').on('click.existing-carousel-dot', '.existing-images-carousel .carousel-dot', function() {
        const container = $(this).closest('.existing-images-carousel');
        const targetIndex = parseInt($(this).data('index'));
        
        // Update active slide and dot
        container.find('.carousel-slide.active').removeClass('active');
        container.find('.carousel-dot.active').removeClass('active');
        
        container.find(`.carousel-slide[data-index="${targetIndex}"]`).addClass('active');
        $(this).addClass('active');
      });

      // Remove image button handlers
      $(document).off('click.remove-image-btn').on('click.remove-image-btn', '.remove-image-btn', function() {
        const imagePath = $(this).data('image-path');
        const productId = $('#productId').val();
        
        if (confirm('Are you sure you want to remove this image?')) {
          // Add to remove list
          let removeList = $('#removeImages').val() ? JSON.parse($('#removeImages').val()) : [];
          removeList.push(imagePath);
          $('#removeImages').val(JSON.stringify(removeList));
          
          // Remove from display
          $(this).closest('.carousel-slide').remove();
          
          // Update carousel
          const container = $(this).closest('.existing-images-carousel');
          const remainingSlides = container.find('.carousel-slide');
          
          if (remainingSlides.length === 0) {
            $('#existingImagesSection').hide();
          } else {
            // Reset carousel to first slide
            container.find('.carousel-slide').removeClass('active');
            container.find('.carousel-dot').removeClass('active');
            remainingSlides.first().addClass('active');
            container.find('.carousel-dot').first().addClass('active');
          }
        }
      });
      
      // Load footer
      $('#footer').load('footer.html');
      
      // Form Validation Setup
      initializeFormValidation();
    });
    
    // Form Validation Functions
    function initializeFormValidation() {
      // Custom validation methods
      $.validator.addMethod("skuFormat", function(value, element) {
        return this.optional(element) || /^[A-Za-z0-9\-_]+$/.test(value);
      }, "SKU can only contain letters, numbers, hyphens, and underscores");
      
      $.validator.addMethod("priceRange", function(value, element) {
        const price = parseFloat(value);
        return this.optional(element) || (price >= 0.01 && price <= 999999.99);
      }, "Price must be between ‚Ç±0.01 and ‚Ç±999,999.99");
      
      $.validator.addMethod("stockRange", function(value, element) {
        const stock = parseInt(value);
        return this.optional(element) || (stock >= 0 && stock <= 999999);
      }, "Stock must be between 0 and 999,999");
      
      // Initialize form validation
      $("#productForm").validate({
        rules: {
          name: {
            required: true,
            minlength: 3,
            maxlength: 100
          },
          category_id: {
            required: true
          },
          sku: {
            required: true,
            minlength: 3,
            maxlength: 50,
            skuFormat: true
          },
          sell_price: {
            required: true,
            priceRange: true
          },
          stock: {
            required: true,
            stockRange: true
          },
          images: {
            required: function() {
              // Only required for new products
              return $('#productId').val() === '';
            }
          }
        },
        messages: {
          name: {
            required: "Product name is required",
            minlength: "Product name must be at least 3 characters",
            maxlength: "Product name cannot exceed 100 characters"
          },
          category_id: {
            required: "Please select a category"
          },
          sku: {
            required: "SKU is required",
            minlength: "SKU must be at least 3 characters",
            maxlength: "SKU cannot exceed 50 characters",
            skuFormat: "SKU can only contain letters, numbers, hyphens, and underscores"
          },
          sell_price: {
            required: "Price is required",
            priceRange: "Price must be between ‚Ç±0.01 and ‚Ç±999,999.99"
          },
          stock: {
            required: "Stock quantity is required",
            stockRange: "Stock must be between 0 and 999,999"
          },
          images: {
            required: "At least one product image is required"
          }
        },
        errorPlacement: function(error, element) {
          const formGroup = element.closest('.form-group');
          const errorContainer = formGroup.find('.error-message');
          errorContainer.text(error.text());
        },
        highlight: function(element) {
          const formGroup = $(element).closest('.form-group');
          formGroup.removeClass('success').addClass('error');
        },
        unhighlight: function(element) {
          const formGroup = $(element).closest('.form-group');
          formGroup.removeClass('error').addClass('success');
        },
        submitHandler: function(form) {
          // Validate form before submission
          if (!$(form).valid()) {
            showNotification('error', 'Validation Error', 'Please fix the errors before submitting.');
            return false;
          }
          
          // Get form data
          const productId = $('#productId').val();
          const name = $('#productName').val().trim();
          const category = $('#productCategory').val();
          const sku = $('#productSKU').val().trim();
          const price = parseFloat($('#productPrice').val());
          const stock = parseInt($('#productStock').val());
          const status = $('#productStatus').val();
          const description = $('#productDescription').val().trim();
          const images = $('#productImages')[0].files;
          
          // Submit form
          submitProductForm(productId, name, sku, price, category, stock, status, description, images);
          return false; // Prevent default form submission
        }
      });
      
      // Real-time validation feedback
      $('#productName').on('input blur', function() {
        $(this).valid();
      });
      
      $('#productCategory').on('change blur', function() {
        $(this).valid();
      });
      
      $('#productSKU').on('input blur', function() {
        $(this).valid();
      });
      
      $('#productPrice').on('input blur', function() {
        $(this).valid();
      });
      
      $('#productStock').on('input blur', function() {
        $(this).valid();
      });
      
      $('#productImages').on('change', function() {
        $(this).valid();
      });
      
      // Clear validation on modal close
      $('#closeProductModalBtn, #cancelProductBtn').on('click', function() {
        $('#productForm').trigger('reset');
        $('#productForm .form-group').removeClass('error success');
        $('#productForm .error-message, #productForm .success-message').hide();
      });
    }
    
    // Validation helper functions
    function showFieldError(field, message) {
      const formGroup = field.closest('.form-group');
      formGroup.removeClass('success').addClass('error');
      const errorMsg = formGroup.find('.error-message');
      errorMsg.text(message).show();
    }
    
    function showFieldSuccess(field) {
      const formGroup = field.closest('.form-group');
      formGroup.removeClass('error').addClass('success');
    }
    
    function clearFieldValidation(field) {
      const formGroup = field.closest('.form-group');
      formGroup.removeClass('error success');
      formGroup.find('.error-message, .success-message').hide();
    }
  </script>
  
  <!-- Footer -->
  <div id="footer"></div>
</body>
</html> 