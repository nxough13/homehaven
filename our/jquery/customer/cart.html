<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Shopping Cart - Home Haven</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { 
      background: linear-gradient(135deg, #f7f4f0 0%, #e8e0d8 100%); 
      margin: 0; 
      font-family: 'Segoe UI', Arial, sans-serif; 
      min-height: 100vh;
    }
    
    .cart-header {
      background: linear-gradient(135deg, #8B5C2A 0%, #a67c52 100%);
      color: white;
      padding: 2rem 0;
      text-align: center;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(139, 92, 42, 0.2);
    }
    
    .cart-header h1 {
      font-size: 2.5rem;
      font-family: Georgia, serif;
      margin: 0;
      font-weight: 600;
    }
    
    .cart-header p {
      font-size: 1.1rem;
      margin: 0.5rem 0 0 0;
      opacity: 0.9;
    }
    
    .cart-container { 
      max-width: 1200px; 
      margin: 0 auto 120px auto; 
      padding: 0 2rem; 
    }
    
    .cart-summary {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(139, 92, 42, 0.1);
      border: 1px solid rgba(139, 92, 42, 0.1);
    }
    
    .cart-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .summary-item {
      text-align: center;
      padding: 1rem;
      background: linear-gradient(135deg, #f8f5f2 0%, #f2e5d2 100%);
      border-radius: 12px;
      border: 1px solid rgba(139, 92, 42, 0.1);
    }
    
    .summary-value {
      font-size: 2rem;
      font-weight: 700;
      color: #8B5C2A;
      margin-bottom: 0.5rem;
    }
    
    .summary-label {
      font-size: 0.9rem;
      color: #666;
      font-weight: 500;
    }
    
    .cart-title { 
      font-size: 2.2rem; 
      font-family: Georgia, serif; 
      color: #444; 
      margin: 0 0 1.5rem 0; 
      font-weight: 600; 
      text-align: center;
      position: relative;
    }
    
    .cart-title::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #8B5C2A, #a67c52);
      border-radius: 2px;
    }
    
    .cart-item { 
      background: white; 
      border-radius: 20px; 
      display: flex; 
      align-items: center; 
      padding: 1.5rem; 
      margin-bottom: 1rem; 
      box-shadow: 0 4px 20px rgba(139, 92, 42, 0.08);
      border: 1px solid rgba(139, 92, 42, 0.05);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      min-height: 100px;
    }
    
    .cart-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(139, 92, 42, 0.12);
    }
    
    .cart-item-img { 
      width: 80px; 
      height: 80px; 
      border-radius: 16px; 
      background: linear-gradient(135deg, #f2e5d2 0%, #e8e0d8 100%);
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 2rem; 
      margin-right: 1.5rem;
      border: 2px solid rgba(139, 92, 42, 0.1);
      overflow: hidden;
    }
    
    .cart-item-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 14px;
    }
    
    .cart-item-main { 
      flex: 1; 
      display: flex; 
      align-items: center; 
      gap: 1rem; 
    }
    
    .cart-item-details { 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      min-width: 200px; 
    }
    
    .cart-item-name { 
      font-size: 1.3rem; 
      font-family: Georgia, serif; 
      font-weight: 600; 
      color: #333; 
      line-height: 1.2; 
      margin-bottom: 0.5rem;
    }
    
    .cart-item-meta { 
      color: #666; 
      font-size: 0.95rem; 
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .cart-item-seller {
      background: linear-gradient(135deg, #8B5C2A, #a67c52);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .cart-item-color { 
      color: #8B5C2A; 
      font-size: 1rem; 
      margin-left: 1rem; 
      min-width: 100px; 
      text-align: left;
      font-weight: 500;
    }
    
    .cart-item-qtybox { 
      display: flex; 
      align-items: center; 
      background: linear-gradient(135deg, #f8f5f2 0%, #f2e5d2 100%);
      border-radius: 12px; 
      padding: 0.5rem 1rem; 
      gap: 0.5rem; 
      margin: 0 1rem;
      border: 1px solid rgba(139, 92, 42, 0.1);
    }
    
    .cart-item-qtybox button { 
      background: linear-gradient(135deg, #8B5C2A, #a67c52);
      color: white;
      border: none; 
      font-size: 1.2rem; 
      width: 2rem; 
      height: 2rem; 
      cursor: pointer; 
      border-radius: 50%;
      transition: transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .cart-item-qtybox button:hover {
      transform: scale(1.1);
    }
    
    .cart-item-qtybox input { 
      width: 3rem; 
      text-align: center; 
      font-size: 1.1rem; 
      border: none; 
      background: transparent; 
      border-radius: 0; 
      padding: 0;
      font-weight: 600;
      color: #333;
    }
    
    .cart-item-price { 
      font-size: 1.4rem; 
      font-weight: 700; 
      color: #8B5C2A; 
      margin-left: 1rem; 
      min-width: 100px; 
      text-align: right;
      background: linear-gradient(135deg, #f8f5f2 0%, #f2e5d2 100%);
      padding: 0.5rem 1rem;
      border-radius: 12px;
    }
    
    .cart-item-remove { 
      font-size: 1.5rem; 
      color: #e74c3c; 
      background: linear-gradient(135deg, #ff6b6b, #e74c3c);
      color: white;
      border: none; 
      cursor: pointer; 
      margin-left: 1rem; 
      transition: all 0.2s;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .cart-item-remove:hover { 
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }
    
    .cart-item-check { 
      font-size: 1.2rem; 
      margin-right: 1rem; 
      color: #8B5C2A; 
      display: flex; 
      align-items: center; 
    }
    
    .cart-footer { 
      position: fixed; 
      left: 0; 
      bottom: 0; 
      width: 100vw; 
      background: linear-gradient(135deg, #8B5C2A 0%, #a67c52 100%);
      color: white;
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 1.5rem 3rem; 
      z-index: 1002; 
      box-shadow: 0 -4px 20px rgba(139, 92, 42, 0.2);
    }
    
    .cart-back { 
      font-size: 1.2rem; 
      color: white; 
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 0.8rem 1.5rem;
      border-radius: 25px;
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      gap: 0.5em; 
      text-decoration: none; 
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .cart-back:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }
    
    .cart-checkout { 
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white; 
      font-size: 1.2rem; 
      font-weight: 600; 
      border: none; 
      border-radius: 25px; 
      padding: 1rem 2rem; 
      cursor: pointer; 
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
      transition: all 0.2s;
      margin-right: 7rem;
    }
    
    .cart-checkout:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
    }
    
    .empty-cart {
      text-align: center;
      padding: 4rem 2rem;
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(139, 92, 42, 0.1);
      margin: 2rem 0;
    }
    
    .empty-cart-icon {
      font-size: 4rem;
      color: #8B5C2A;
      margin-bottom: 1rem;
    }
    
    .empty-cart h3 {
      font-size: 1.8rem;
      color: #333;
      margin-bottom: 1rem;
      font-family: Georgia, serif;
    }
    
    .empty-cart p {
      color: #666;
      font-size: 1.1rem;
      margin-bottom: 2rem;
    }
    
    .continue-shopping {
      background: linear-gradient(135deg, #8B5C2A, #a67c52);
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 25px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    
    .continue-shopping:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(139, 92, 42, 0.3);
    }
    
    @media (max-width: 700px) {
      .cart-header h1 { font-size: 2rem; }
      .cart-container { margin: 0 auto 120px auto; padding: 0 1rem; }
      .cart-item { flex-direction: column; align-items: flex-start; padding: 1rem; }
      .cart-item-img { margin: 0 0 1rem 0; width: 60px; height: 60px; }
      .cart-item-qtybox { margin: 1rem 0; }
      .cart-item-price { margin: 1rem 0 0 0; text-align: left; }
      .cart-footer { flex-direction: column; gap: 1rem; padding: 1rem; }
      .cart-checkout { margin-right: 0; width: 100%; }
      .cart-summary-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Header Container -->
  <div id="headerContainer"></div>
  
  <!-- Cart Header -->
  <div class="cart-header">
    <h1>ðŸ›’ Your Shopping Cart</h1>
    <p>Review your items and proceed to checkout</p>
  </div>
  
  <div class="cart-container">
    <!-- Cart Summary -->
    <div class="cart-summary">
      <div class="cart-summary-grid">
        <div class="summary-item">
          <div class="summary-value" id="totalItems">0</div>
          <div class="summary-label">Items in Cart</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="totalValue">â‚±0.00</div>
          <div class="summary-label">Total Value</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="uniqueSellers">0</div>
          <div class="summary-label">Unique Sellers</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="estimatedDelivery">1-3 days</div>
          <div class="summary-label">Estimated Delivery</div>
        </div>
      </div>
    </div>
    
    <div class="cart-title">Cart Items</div>
    <div id="cartItemsContainer">
      <!-- Cart items will be loaded here -->
    </div>
  </div>
  
  <div class="cart-footer">
    <a href="product_customer.html" class="cart-back">&#8592; Back to Shop</a>
    <button class="cart-checkout">Checkout: â‚±0.00</button>
  </div>
  
  <div id="outOfStockToast" class="out-of-stock-toast" style="display:none;"></div>
  

  
  <script>
    // Load header
    $(function() {
      $("#headerContainer").load("../header.html");
    });
    
    // Cart functionality
const API_BASE = 'http://localhost:4000/api/v1';
const token = localStorage.getItem('jwt_token');
const isLoggedIn = !!token;

// Load cart from backend or localStorage and render
async function loadCart() {
  let cart = [];
  if (isLoggedIn) {
    // Fetch cart from backend
    try {
      const res = await fetch(`${API_BASE}/cart`, { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();
      if (data.success) {
        cart = data.cart.map(item => ({ productId: item.item_id, quantity: item.quantity, price: item.price }));
      }
    } catch {}
  } else {
    cart = JSON.parse(localStorage.getItem('cart') || '[]');
  }
  
  if (!cart.length) {
    document.querySelector('#cartItemsContainer').innerHTML = `
      <div class="empty-cart">
        <div class="empty-cart-icon">ðŸ›’</div>
        <h3>Your cart is empty</h3>
        <p>Looks like you haven't added any items to your cart yet.</p>
        <a href="product_customer.html" class="continue-shopping">Continue Shopping</a>
      </div>
    `;
    document.querySelector('.cart-footer').innerHTML = '<a href="product_customer.html" class="cart-back">&#8592; Back to Shop</a><button class="cart-checkout">Checkout: â‚±0.00</button>';
    updateCartSummary(0, 0, 0);
    return;
  }
  
  // Fetch product details for each item
  let products = [];
  for (const item of cart) {
    try {
      const res = await fetch(`${API_BASE}/products/details/${item.productId}`);
      const data = await res.json();
      if (data && data.product) {
        products.push({ ...data.product, quantity: item.quantity, price: item.price });
      }
    } catch {}
  }
  
  // Calculate summary statistics
  let total = 0;
  let totalItems = 0;
  const uniqueSellers = new Set();
  
  products.forEach(product => {
    const subtotal = (product.price || product.sell_price) * product.quantity;
    total += subtotal;
    totalItems += product.quantity;
    if (product.seller_name) uniqueSellers.add(product.seller_name);
  });
  
  // Update summary
  updateCartSummary(totalItems, total, uniqueSellers.size);
  
  // Render cart items
  let html = '';
  products.forEach(product => {
    const subtotal = (product.price || product.sell_price) * product.quantity;
    const sellerName = product.seller_name || 'Home Haven';
    
    html += `<div class="cart-item" data-product-id="${product.item_id}" data-stock="${product.stock_quantity}">
      <div class="cart-item-img">
        ${Array.isArray(product.image) && product.image[0] ?
          `<img src="${product.image[0].startsWith('http') ? product.image[0] : `/our${product.image[0]}`}" alt="${product.name}">` :
          `<div class="product-image-placeholder"><i class="fas fa-couch"></i></div>`
        }
      </div>
      <div class="cart-item-main">
        <div class="cart-item-details">
          <div class="cart-item-name">${product.name}</div>
          <div class="cart-item-meta">
            <span class="cart-item-seller">${sellerName}</span>
            <span>SKU: ${product.sku || 'N/A'}</span>
          </div>
        </div>
        <div class="cart-item-qtybox">
          <button onclick="updateQty(${product.item_id}, -1)">-</button>
          <input type="text" value="${product.quantity}" readonly>
          <button onclick="updateQty(${product.item_id}, 1)">+</button>
        </div>
        <div class="cart-item-price">â‚±${subtotal.toLocaleString()}</div>
        <button class="cart-item-remove" onclick="removeFromCart(${product.item_id})">Ã—</button>
      </div>
    </div>`;
  });
  
  document.querySelector('#cartItemsContainer').innerHTML = html;
  document.querySelector('.cart-footer').innerHTML = `<a href="product_customer.html" class="cart-back">&#8592; Back to Shop</a><button class="cart-checkout" type="button">Checkout: â‚±${total.toLocaleString()}</button>`;

      // Attach checkout handler
  $(document).off('click', '.cart-checkout').on('click', '.cart-checkout', async function(e) {
    e.preventDefault();
    e.stopPropagation();
    const cartItems = document.querySelectorAll('.cart-item');
    const outOfStockItems = [];
    cartItems.forEach(item => {
      const qtyInput = item.querySelector('.cart-item-qtybox input');
      const quantity = parseInt(qtyInput.value, 10);
      const stock = parseInt(item.getAttribute('data-stock'), 10);
      const name = item.querySelector('.cart-item-name').textContent;
      if (stock === 0 || quantity > stock) {
        outOfStockItems.push(name);
      }
    });
    if (outOfStockItems.length) {
      showOutOfStockToast(outOfStockItems);
      return false;
    }
    window.location.href = 'checkout.html';
    return false;
  });
}

// Update cart summary
function updateCartSummary(totalItems, totalValue, uniqueSellers) {
  document.getElementById('totalItems').textContent = totalItems;
  document.getElementById('totalValue').textContent = `â‚±${totalValue.toLocaleString()}`;
  document.getElementById('uniqueSellers').textContent = uniqueSellers;
}

async function updateQty(productId, delta) {
  if (isLoggedIn) {
    // Update quantity in backend
    let cart = [];
    try {
      const res = await fetch(`${API_BASE}/cart`, { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();
      if (data.success) cart = data.cart;
    } catch {}
    const item = cart.find(i => i.item_id === productId);
    if (item) {
      let newQty = item.quantity + delta;
      if (newQty < 1) newQty = 1;
      await fetch(`${API_BASE}/cart/add`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ item_id: productId, quantity: delta, price: item.price })
      });
      loadCart();
    }
  } else {
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const item = cart.find(i => i.productId === productId);
    if (item) {
      item.quantity += delta;
      if (item.quantity < 1) item.quantity = 1;
      localStorage.setItem('cart', JSON.stringify(cart));
      loadCart();
    }
  }
}

async function removeFromCart(productId) {
  if (isLoggedIn) {
    await fetch(`${API_BASE}/cart/remove`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ item_id: productId })
    });
    loadCart();
  } else {
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    cart = cart.filter(i => i.productId !== productId);
    localStorage.setItem('cart', JSON.stringify(cart));
    loadCart();
  }
}

function showOutOfStockToast(items) {
  const toast = document.getElementById('outOfStockToast');
  toast.innerHTML = `<strong>Cannot Checkout</strong><br>The following items are out of stock or exceed available stock:<br><b>${items.join(", ")}</b>`;
  toast.style.display = 'block';
  setTimeout(() => {
    toast.style.display = 'none';
  }, 4000);
}

    // Load cart when page loads
    document.addEventListener('DOMContentLoaded', loadCart);
</script>
</body>
</html> 